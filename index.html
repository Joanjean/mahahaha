<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>â˜€ï¸ë§ˆí•œí´ ë„¤ë²„ìŠ¤íƒ‘ğŸ”¥</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <style>
        :root { 
            --aurora-bg: linear-gradient(215deg, #d4fc79 0%, #96e6a1 20%, #84fab0 40%, #8fd3f4 60%, #a18cd1 80%, #fbc2eb 100%);
            --pitch-dark: #4a148c; --white: #ffffff; --bg: #f8f9fa; --gray: #e0e0e0; --accent: #fffb00; 
        }
        body { font-family: 'Pretendard', -apple-system, sans-serif; background-color: #f0f0f0; margin: 0; display: flex; justify-content: center; overflow-x: hidden; }
        .app-container { width: 100%; max-width: 480px; min-height: 100vh; background: var(--white); display: none; flex-direction: column; position: relative; padding-bottom: 80px; }
        
        /* ëœë”© & í”„ë¡œí•„ */
        #landingScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--aurora-bg); background-size: 400% 400%; animation: auroraMove 10s ease infinite; z-index: 3000; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.8s ease-out; }
        @keyframes auroraMove { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .rolling-ball { font-size: 60px; position: absolute; left: -100px; animation: rollAction 2.2s cubic-bezier(0.25, 1, 0.5, 1) forwards; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2)); }
        .landing-text { color: #fff; font-size: 22px; font-weight: 900; margin-top: 30px; opacity: 0; animation: fadeIn 1s 1.2s forwards; text-align: center; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }

        #profileOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--aurora-bg); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(10px); }
        .profile-card { background: white; padding: 25px; border-radius: 24px; width: 85%; max-width: 340px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .emoji-picker { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; height: 300px; overflow-y: auto; border: 1px solid #eee; padding: 12px; border-radius: 12px; margin-bottom: 20px; background: #fafafa; }
        .emoji-item { font-size: 24px; cursor: pointer; padding: 8px 0; border-radius: 8px; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .emoji-item.selected { background: #e1bee7; transform: scale(1.1); }

        /* ê³µí†µ ìŠ¤íƒ€ì¼ */
        .home-header, .header-card { background: var(--aurora-bg); background-size: 200% 200%; padding: 40px 20px; color: white; border-radius: 0 0 30px 30px; }
        .weather-info { display: flex; align-items: center; gap: 15px; margin-top: 10px; }
        .temp { font-size: 2.5rem; font-weight: 900; }
        .section-title { font-size: 18px; font-weight: 800; margin: 25px 20px 10px; color: #333; display: flex; justify-content: space-between; align-items: center; }
        .todo-item-card { background: #fff; border: 1px solid #eee; border-radius: 15px; padding: 15px; margin: 0 20px 10px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .mini-feed-card { background: #fafafa; border-radius: 12px; padding: 12px; margin: 0 20px 8px; display: flex; align-items: center; gap: 10px; border-left: 4px solid #a18cd1; }
        
        /* í›ˆë ¨ ì¹´ë“œ & ì‚¬ì§„ */
        .train-card { background: #fff; border: 1px solid #f0f0f0; border-radius: 20px; padding: 18px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.04); position: relative; }
        .post-img { width: 100%; border-radius: 15px; margin-top: 12px; display: block; border: 1px solid #eee; }
        #imgPreview { width: 100%; height: 180px; object-fit: cover; border-radius: 15px; margin-bottom: 10px; display: none; border: 2px solid #a18cd1; }
        .upload-bar { display: flex; gap: 8px; margin-bottom: 20px; align-items: center; }
        .photo-btn { width: 45px; height: 45px; background: #f0f0f0; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; border: 1px solid #ddd; }

        /* ë­í‚¹ ì¹´ë“œ */
        .rank-card { background: #fff; border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .rank-title { font-size: 16px; font-weight: 800; color: #4a148c; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .rank-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f9f9f9; }
        .rank-badge { width: 24px; height: 24px; border-radius: 50%; background: var(--gray); color: white; font-size: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .rank-item:nth-child(1) .rank-badge { background: #FFD700; }
        .rank-item:nth-child(2) .rank-badge { background: #C0C0C0; }
        .rank-item:nth-child(3) .rank-badge { background: #CD7F32; }
        .rank-score { font-size: 13px; color: #7b1fa2; font-weight: bold; }

        /* ìº˜ë¦°ë” */
        .week-grid { display: flex; overflow-x: auto; gap: 10px; padding: 10px 0; scrollbar-width: none; }
        .week-grid::-webkit-scrollbar { display: none; }
        .day-box { flex: 0 0 50px; background: rgba(255,255,255,0.2); border-radius: 12px; padding: 12px 0; text-align: center; cursor: pointer; transition: 0.2s; }
        .day-box.active { background: var(--white); color: #7b1fa2; font-weight: bold; transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* ê³µì§€ì‚¬í•­ ê´€ë ¨ */
        .notice-bar { position: fixed; bottom: 0; left: 0; width: 100%; max-width: 480px; background: #4a148c; color: white; padding: 12px 20px; display: flex; align-items: center; gap: 10px; cursor: pointer; box-sizing: border-box; z-index: 1000; font-size: 13px; }
        .notice-badge { background: var(--accent); color: #000; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 10px; }
        .notice-content { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }

        #sideMenu { position: absolute; top: 70px; left: 15px; width: 200px; background: white; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: none; flex-direction: column; z-index: 100; overflow: hidden; }
        .menu-item { padding: 15px; border-bottom: 1px solid #f0f0f0; font-size: 14px; color: #333; cursor: pointer; }
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s ease; }

        @keyframes rollAction { 0% { left: -100px; transform: rotate(0deg); } 100% { left: calc(50% - 30px); transform: rotate(720deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="landingScreen">
    <div class="ball-container"><div class="rolling-ball">âš½ï¸</div></div>
    <div class="landing-text">JUST DO IT.<br>MAPO LOAFERS</div>
</div>

<div id="profileOverlay">
    <div class="profile-card">
        <h3 id="modalTitle">ğŸƒâ€â™€ï¸ í”„ë¡œí•„ ì„¤ì •</h3>
        <p style="font-size: 13px; color: #666; margin-bottom: 15px;">ë‚˜ë¥¼ ì˜ ë‚˜íƒ€ë‚´ëŠ” ì´ëª¨ì§€ë¥¼ ê³¨ë¼ì£¼ì„¸ìš”!</p>
        <input type="text" id="nickInput" onkeypress="if(event.keyCode==13) saveProfile()" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" maxlength="6" style="width:90%; padding:12px; margin-bottom:15px; border-radius:10px; border:1px solid #ddd; text-align:center; font-size:16px;">
        <div id="emojiPicker" class="emoji-picker"></div>
        <button onclick="saveProfile()" style="width:100%; height:55px; background:linear-gradient(to right, #a18cd1, #fbc2eb); color:white; border:none; border-radius:12px; font-weight:bold; cursor:pointer; font-size:16px;">ì €ì¥í•˜ê³  ì‹œì‘í•˜ê¸°</button>
    </div>
</div>

<div class="app-container" id="mainApp">
    <div class="notice-bar" onclick="switchView('notice')">
        <span class="notice-badge">NOTICE</span>
        <div class="notice-content" id="latestNoticeText">ê³µì§€ì‚¬í•­ ë¡œë”© ì¤‘...</div>
        <span>â¯</span>
    </div>

    <main id="homeView" class="view-section active">
        <div class="home-header">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div id="todayDate" style="font-size: 1rem; font-weight: bold;">--ë…„ --ì›” --ì¼</div>
                <div onclick="toggleMenu()" style="cursor:pointer; background:rgba(255,255,255,0.3); padding:6px 14px; border-radius:20px; font-size:13px; font-weight:bold;">ë©”ë‰´</div>
            </div>
            <div class="weather-info">
                <div id="weatherIcon" style="font-size: 3rem;">â˜€ï¸</div>
                <div><div class="temp" id="currentTemp">--Â°</div><div id="weatherDesc" style="font-weight: 600;">ë‚ ì”¨ ë¡œë”© ì¤‘...</div></div>
            </div>
        </div>
        <div class="section-title"><span>ğŸ“… ë‚˜ì˜ í›ˆë ¨ ì¼ì •</span><button onclick="switchView('todo')" style="background:none; border:none; color:#7b1fa2; font-weight:bold; font-size:12px;">ì „ì²´ë³´ê¸°</button></div>
        <div id="todoPreviewContainer"></div>
        <div class="section-title" style="margin-top:10px;"><span>ğŸ”¥ ì¹œêµ¬ë“¤ì˜ í›ˆë ¨</span><button onclick="switchView('feed')" style="background:none; border:none; color:#7b1fa2; font-weight:bold; font-size:12px;">ë”ë³´ê¸°</button></div>
        <div id="homeFeedContainer"></div>
    </main>

    <main id="todoView" class="view-section">
        <header class="header-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div style="background:rgba(255,255,255,0.3); padding:6px 16px; border-radius:30px; font-weight:bold;"><span id="myEmoji"></span> <span id="myNick"></span></div>
                <div onclick="switchView('home')" style="cursor:pointer; font-weight:bold; background:rgba(255,255,255,0.3); padding:6px 14px; border-radius:20px; font-size:13px;">ğŸ  HOME</div>
            </div>
            <div id="calendarArea" class="week-grid"></div>
        </header>
        <div style="padding:20px;">
            <h4 id="dateLabel" style="color:#4a148c; margin-top:0;">ğŸ“… ë‚˜ì˜ í›ˆë ¨ ì¼ì •</h4>
            <img id="imgPreview">
            <div class="upload-bar">
                <label class="photo-btn" for="photoInput">ğŸ“·</label>
                <input type="file" id="photoInput" accept="image/*" style="display:none;" onchange="handleImage(this)">
                <input type="text" id="trainInput" onkeypress="if(event.keyCode==13) pushTraining()" placeholder="ì˜¤ëŠ˜ì˜ í›ˆë ¨ì€?" style="flex:1; padding:12px; border:1px solid #ddd; border-radius:10px;">
                <button onclick="pushTraining()" id="uploadBtn" style="background:#a18cd1; color:white; border:none; border-radius:10px; padding:0 15px; height:45px; font-weight:bold;">ë“±ë¡</button>
            </div>
            <div id="trainingContainer"></div>
        </div>
    </main>

    <main id="feedView" class="view-section">
        <div class="header-card" style="padding: 20px;"><div style="display:flex; justify-content:space-between; align-items:center;"><span style="font-weight:bold;">ğŸ‘€ ì¹œêµ¬ë“¤ ì˜í•˜ê³  ìˆë‚˜?</span><span onclick="switchView('home')" style="cursor:pointer; background:rgba(255,255,255,0.3); padding:6px 14px; border-radius:20px; font-size:13px;">ğŸ </span></div></div>
        <div id="feedContainer" style="padding:20px;"></div>
    </main>

    <main id="rankView" class="view-section">
        <div class="header-card" style="padding: 20px;"><div style="display:flex; justify-content:space-between; align-items:center;"><span style="font-weight:bold;">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</span><span onclick="switchView('home')" style="cursor:pointer; background:rgba(255,255,255,0.3); padding:6px 14px; border-radius:20px; font-size:13px;">ğŸ </span></div></div>
        <div style="padding:20px;">
            <div class="rank-card"><div class="rank-title">ğŸ”¥ í›ˆë ¨ê³„íšì™•</div><div id="planRankList">ê³„ì‚° ì¤‘...</div></div>
            <div class="rank-card"><div class="rank-title">â­ í›ˆë ¨ë‹¬ì„±ì™•</div><div id="scoreRankList">ê³„ì‚° ì¤‘...</div></div>
            <div class="rank-card"><div class="rank-title">ğŸ’¬ ëŒ“ê¸€ì‘ì›ì™•</div><div id="commentRankList">ê³„ì‚° ì¤‘...</div></div>
        </div>
    </main>

    <main id="noticeView" class="view-section">
        <div class="header-card" style="padding: 20px;"><div style="display:flex; justify-content:space-between; align-items:center;"><span style="font-weight:bold;">ğŸ“¢ ê³µì§€ì‚¬í•­</span><span onclick="switchView('home')" style="cursor:pointer; background:rgba(255,255,255,0.3); padding:6px 14px; border-radius:20px; font-size:13px;">ğŸ </span></div></div>
        <div style="padding:20px;">
            <div style="background:#f0f0f0; padding:15px; border-radius:12px; margin-bottom:20px;">
                <input type="text" id="noticeTitleInput" placeholder="ê³µì§€ ì œëª©" style="width:100%; padding:10px; margin-bottom:8px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box;">
                <textarea id="noticeBodyInput" placeholder="ê³µì§€ ë‚´ìš©" style="width:100%; padding:10px; height:80px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box;"></textarea>
                <button onclick="pushNotice()" style="width:100%; padding:12px; background:#4a148c; color:white; border:none; border-radius:8px; margin-top:8px; font-weight:bold;">ê³µì§€ ë“±ë¡</button>
            </div>
            <div id="noticeList"></div>
        </div>
    </main>

    <div id="sideMenu">
        <div class="menu-item" onclick="switchView('home')">ğŸ  í™ˆìœ¼ë¡œ</div>
        <div class="menu-item" onclick="switchView('todo')">ğŸ“… ë‚˜ì˜ í›ˆë ¨</div>
        <div class="menu-item" onclick="switchView('feed')">ğŸ‘€ ì¹œêµ¬ë“¤ í›ˆë ¨</div>
        <div class="menu-item" onclick="switchView('rank')">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</div>
        <div class="menu-item" onclick="switchView('notice')">ğŸ“¢ ê³µì§€ì‚¬í•­</div>
        <div class="menu-item" onclick="openProfileEdit()">âš™ï¸ í”„ë¡œí•„ ìˆ˜ì •</div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCCUWntonGOrv9_7pMODamJEf2hFwCex5I",
        authDomain: "maha-trainee.firebaseapp.com",
        databaseURL: "https://maha-trainee-default-rtdb.firebaseio.com",
        projectId: "maha-trainee",
        storageBucket: "maha-trainee.firebasestorage.app",
        messagingSenderId: "474313055531",
        appId: "1:474313055531:web:a7779782c1d196e06bb96e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    let user = JSON.parse(localStorage.getItem('futsal_user'));
    let selectedDate = new Date().toISOString().split('T')[0];
    let chosenEmoji = "âš½ï¸";
    let compressedBlob = null;
    
    const emojis = ["ğŸƒâ€â™€ï¸","ğŸ‹ï¸â€â™€ï¸","ğŸš´â€â™‚ï¸","ğŸšµâ€â™€ï¸","ğŸšµâ€â™‚ï¸","ğŸ¤¸â€â™€ï¸","ğŸ§˜â€â™€ï¸","ğŸŠâ€â™€ï¸","ğŸ¤½â€â™€ï¸","â›¹ï¸â€â™€ï¸","ğŸ„â€â™€ï¸","ğŸ§—â€â™€ï¸","â›·ï¸","ğŸ‚","ğŸŒï¸â€â™€ï¸","ğŸ¤º","ğŸ‡"," skating ","ğŸ¤¼â€â™€ï¸","ğŸ¤¼â€â™‚ï¸","ğŸ¤¸","ğŸ‹ï¸","ğŸ§˜","ğŸ¤º","â›¹ï¸","ğŸŠ","ğŸš£","ğŸ„","ğŸš´","ğŸšµ","ğŸ¤¾â€â™€ï¸","ğŸ¤¾â€â™‚ï¸","ğŸŒï¸","ğŸ‡","ğŸ˜€","ğŸ˜ƒ","ğŸ˜„","ğŸ˜","ğŸ˜†","ğŸ˜…","ğŸ˜‚","ğŸ¤£","â˜ºï¸","ğŸ˜Š","ğŸ˜‡","ğŸ™‚","ğŸ™ƒ","ğŸ˜‰","ğŸ˜Œ","ğŸ˜","ğŸ¥°","ğŸ˜˜","ğŸ˜—","ğŸ˜™","ğŸ˜š","ğŸ˜‹","ğŸ˜›","ğŸ˜","ğŸ˜œ","ğŸ¤ª","ğŸ¤¨","ğŸ§","ğŸ¤“","ğŸ˜","ğŸ¤©","ğŸ¥³","ğŸ˜","ğŸ˜’","ğŸ˜","ğŸ˜”","ğŸ˜Ÿ","ğŸ˜•","ğŸ™","â˜¹ï¸","ğŸ˜£","ğŸ˜–","ğŸ˜«","ğŸ˜©","ğŸ¥º","ğŸ˜¢","ğŸ˜­","ğŸ˜¤","ğŸ˜ ","ğŸ˜¡","ğŸ¤¬","ğŸ¤¯","ğŸ˜³","ğŸ¥µ","ğŸ¥¶","ğŸ˜±","ğŸ˜¨","ğŸ˜°","ğŸ˜¥","ğŸ˜“","ğŸ¤—","ğŸ¤”","ğŸ¤­","ğŸ¤«","ğŸ¤¥","ğŸ˜¶","ğŸ˜","ğŸ˜‘","ğŸ˜¬","ğŸ™„","ğŸ˜¯","ğŸ˜¦","ğŸ˜§","ğŸ˜®","ğŸ˜²","ğŸ¥±","ğŸ˜´","ğŸ¤¤","ğŸ˜ª","ğŸ˜µ","ğŸ¤","ğŸ¥´","ğŸ¤¢","ğŸ¤®","ì„±ê³¼","ğŸ¤’","ğŸ¤•","ğŸ¶","ğŸ±","ğŸ­","ğŸ¹","ğŸ°","ğŸ¦Š","ğŸ»","ğŸ¼","ğŸ¨","ğŸ¯","ğŸ¦","ğŸ®","ğŸ·","ğŸ½","ğŸ¸","ğŸ­","ğŸ™ˆ","ğŸ™‰","ğŸ™Š","ğŸ’","ğŸ”","ğŸ§","ğŸ¦","ğŸ¤","ğŸ£","ğŸ¥","ğŸ¦†","ğŸ¦¢","ğŸ¦‰","ğŸ¦š","ğŸ¦œ","ğŸº","ğŸ—","ğŸ´","ğŸ¦„","ğŸ","ğŸ›","ğŸ¦‹","ğŸ","ğŸœ","ğŸ¦Ÿ","ğŸ¦—","ğŸ•·ï¸","ğŸ•¸ï¸","ğŸ¢","ğŸ","ğŸ¦","ğŸ™","ğŸ¦‘","ğŸ¦","ğŸ¦","ğŸ¦€","ğŸ¡","ğŸ ","ğŸŸ","ğŸ¬","ğŸ³","ğŸ‹","ğŸŠ","ğŸ…","ğŸ†","ğŸ¦“","ğŸ¦","ğŸ¦§","ğŸ˜","ğŸ¦›","ğŸ¦","ğŸª","ğŸ«","ğŸ¦’","ğŸ¦˜","ğŸƒ","ğŸ‚","ğŸ„","ğŸ","ğŸ–","ğŸ","ğŸ‘","ğŸ","ğŸ¦Œ","ğŸ•","ğŸ©","ğŸˆ","ğŸ“","ğŸ¦ƒ","ğŸ•Šï¸","ğŸ‡","ğŸ","ğŸ€","ğŸ¿ï¸","ğŸ¦”","ğŸ¾","ğŸ‰","ğŸ²","âš½ï¸","ğŸ‘Ÿ","ğŸ”¥","ğŸ†","ğŸ¥‡","ğŸ¥Š","ğŸ¥‹","ğŸ‘½","ğŸ‘»","ğŸ’©","ğŸ§¤","â¤ï¸","ğŸ‘„","âœ¨","âš¡ï¸","ğŸŒŸ","â­","ğŸ’ª","ğŸŒˆ","ğŸ•","ğŸ”","ğŸ¦","ğŸš€"];

    window.addEventListener('DOMContentLoaded', () => {
        initEmojiPicker();
        setTimeout(() => {
            document.getElementById('landingScreen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('landingScreen').style.display = 'none';
                checkUserStatus();
                loadLatestNotice();
            }, 800);
        }, 2500);
    });

    function checkUserStatus() {
        if(!user || !user.uid) document.getElementById('profileOverlay').style.display = 'flex';
        else { document.getElementById('mainApp').style.display = 'flex'; updateUI(); }
    }

    function saveProfile() {
        const nick = document.getElementById('nickInput').value.trim();
        if(!nick) return alert("ë‹‰ë„¤ì„ ì…ë ¥!");
        const uid = (user && user.uid) ? user.uid : 'user_' + Math.random().toString(36).substr(2, 9);
        user = { uid, nick, emoji: chosenEmoji };
        localStorage.setItem('futsal_user', JSON.stringify(user));
        location.reload();
    }

    function initEmojiPicker() {
        const picker = document.getElementById('emojiPicker');
        if(!picker) return; picker.innerHTML = '';
        emojis.forEach(e => {
            const span = document.createElement('div');
            span.className = `emoji-item ${e === chosenEmoji ? 'selected' : ''}`;
            span.innerText = e;
            span.onclick = () => {
                document.querySelectorAll('.emoji-item').forEach(el => el.classList.remove('selected'));
                span.classList.add('selected'); chosenEmoji = e;
            };
            picker.appendChild(span);
        });
    }

    // ì‚¬ì§„ ì••ì¶• ë¡œì§
    function handleImage(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width, height = img.height;
                const max_size = 600; // ê°€ë¡œì„¸ë¡œ ìµœëŒ€ 600px
                if (width > height) { if (width > max_size) { height *= max_size / width; width = max_size; } }
                else { if (height > max_size) { width *= max_size / height; height = max_size; } }
                canvas.width = width; canvas.height = height;
                canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                canvas.toBlob((blob) => {
                    compressedBlob = blob;
                    const preview = document.getElementById('imgPreview');
                    preview.src = URL.createObjectURL(blob);
                    preview.style.display = 'block';
                }, 'image/jpeg', 0.6); // 60% ì••ì¶•
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    async function pushTraining() {
        const input = document.getElementById('trainInput');
        if(!input.value) return alert("í›ˆë ¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”!");
        
        const btn = document.getElementById('uploadBtn');
        btn.disabled = true; btn.innerText = "ì—…ë¡œë“œì¤‘...";

        let imageUrl = "";
        if(compressedBlob) {
            const fileName = `trains/${user.uid}_${Date.now()}.jpg`;
            const ref = storage.ref().child(fileName);
            await ref.put(compressedBlob);
            imageUrl = await ref.getDownloadURL();
        }

        db.ref(`trainings/${selectedDate}`).push({
            uid: user.uid, nick: user.nick, emoji: user.emoji,
            text: input.value, imageUrl, score: 0, timestamp: Date.now()
        });

        input.value = '';
        document.getElementById('imgPreview').style.display = 'none';
        compressedBlob = null;
        btn.disabled = false; btn.innerText = "ë“±ë¡";
    }

    function renderCard(container, data, key, isMine, dateKey) {
        const card = document.createElement('div');
        card.className = 'train-card';
        const displayDate = dateKey.split('-').slice(1).join('/');

        card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <div>
                    <span style="font-size:0.75rem; color:#a18cd1; font-weight:bold;">${displayDate}</span><br>
                    <span style="font-size:0.8rem; color:#888;">${data.nick} ${data.emoji}</span><br>
                    <strong style="font-size:1.1rem;">${data.text}</strong>
                </div>
                ${isMine ? `<div style="display:flex; gap:10px;"><button onclick="editPost('${dateKey}','${key}','${data.text}')" style="border:none;background:none;color:#a18cd1;font-size:12px;font-weight:bold;">ìˆ˜ì •</button><button onclick="deletePost('${dateKey}','${key}')" style="border:none;background:none;color:red;font-size:12px;font-weight:bold;">ì‚­ì œ</button></div>` : ''}
            </div>
            ${data.imageUrl ? `<img src="${data.imageUrl}" class="post-img" loading="lazy">` : ''}
            <div class="dot-container">${[1,2,3,4,5].map(i => `<div class="dot ${data.score >= i ? 'active' : ''}" onclick="${isMine ? `updateScore('${dateKey}','${key}',${i})` : ''}"></div>`).join('')}</div>
            <div class="comment-section" style="border-top:1px solid #f5f5f5; padding-top:10px; margin-top:10px;">
                <div id="comments-${key}"></div>
                <div style="display:flex; gap:5px; margin-top:10px;">
                    <input type="text" id="c-input-${key}" onkeypress="if(event.keyCode==13) addComment('${key}')" placeholder="ì‘ì›..." style="flex:1; padding:8px; border:1px solid #eee; border-radius:8px; font-size:13px;">
                    <button onclick="addComment('${key}')" style="background:#a18cd1; color:white; border:none; border-radius:8px; cursor:pointer;">ğŸ’¬</button>
                </div>
            </div>`;
        container.prepend(card);
        loadComments(key);
    }

    // ê¸°ëŠ¥ë“¤ (ê¸°ì¡´ 0121 ë²„ì „ ë¡œì§)
    function loadTrainings() { db.ref(`trainings/${selectedDate}`).on('value', (snapshot) => { const container = document.getElementById('trainingContainer'); container.innerHTML = ''; snapshot.forEach((child) => { if(child.val().uid === user.uid) renderCard(container, child.val(), child.key, true, selectedDate); }); }); }
    function loadGlobalFeed() { db.ref('trainings').on('value', (snapshot) => { const container = document.getElementById('feedContainer'); container.innerHTML = ''; snapshot.forEach(dateNode => { dateNode.forEach(trainNode => { if(trainNode.val().uid !== user.uid) renderCard(container, trainNode.val(), trainNode.key, false, dateNode.key); }); }); }); }
    function loadComments(tK) { db.ref(`comments/${tK}`).on('value', (snapshot) => { const box = document.getElementById(`comments-${tK}`); if(!box) return; box.innerHTML = ''; snapshot.forEach(c => { const d = c.val(); box.innerHTML += `<div style="font-size:13px; margin-bottom:5px;"><b>${d.nick}</b> ${d.text} ${d.nick === user.nick ? `<span onclick="deleteComment('${tK}','${c.key}')" style="color:red; cursor:pointer; font-size:10px; margin-left:5px;">ì‚­ì œ</span>`:''}</div>`; }); }); }
    function addComment(tK) { const input = document.getElementById(`c-input-${tK}`); if(!input.value) return; db.ref(`comments/${tK}`).push({ nick: user.nick, text: input.value }); input.value = ''; }
    function deleteComment(tK, cK) { if(confirm("ì‚­ì œ?")) db.ref(`comments/${tK}/${cK}`).remove(); }
    function updateScore(dK, tK, s) { db.ref(`trainings/${dK}/${tK}`).update({ score: s }); }
    function deletePost(dK, tK) { if(confirm("í›ˆë ¨ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) db.ref(`trainings/${dK}/${tK}`).remove(); }
    function editPost(dK, tK, old) { const nt = prompt("ë‚´ìš© ìˆ˜ì •:", old); if(nt) db.ref(`trainings/${dK}/${tK}`).update({ text: nt }); }

    // ë­í‚¹ ì‹œìŠ¤í…œ
    async function calculateRanks() {
        const currentMonth = new Date().toISOString().slice(0, 7);
        let planCounts = {}, scoreCounts = {}, commentCounts = {}, userEmojiMap = {};
        const trainSnap = await db.ref('trainings').once('value');
        trainSnap.forEach(dateNode => { dateNode.forEach(trainNode => { 
            const d = trainNode.val(); userEmojiMap[d.nick] = d.emoji;
            if (dateNode.key.startsWith(currentMonth)) {
                planCounts[d.nick] = (planCounts[d.nick] || 0) + 1;
                scoreCounts[d.nick] = (scoreCounts[d.nick] || 0) + (d.score || 0);
            }
        });});
        const commentSnap = await db.ref('comments').once('value');
        commentSnap.forEach(postNode => { postNode.forEach(commentNode => { commentCounts[commentNode.val().nick] = (commentCounts[commentNode.val().nick] || 0) + 1; }); });
        renderRankList('planRankList', planCounts, 'íšŒ', userEmojiMap);
        renderRankList('scoreRankList', scoreCounts, 'ì ', userEmojiMap);
        renderRankList('commentRankList', commentCounts, 'ê°œ', userEmojiMap);
    }
    function renderRankList(elementId, dataObj, unit, emojiMap) {
        const container = document.getElementById(elementId);
        const sorted = Object.entries(dataObj).map(([nick, val]) => ({ nick, val, emoji: emojiMap[nick] || 'ğŸ‘¤' })).sort((a, b) => b.val - a.val).slice(0, 3);
        if(!sorted.length) { container.innerHTML = '<div style="font-size:12px; color:#aaa; text-align:center;">ë°ì´í„° ì—†ìŒ</div>'; return; }
        container.innerHTML = sorted.map((item, idx) => `<div class="rank-item"><div class="rank-badge">${idx + 1}</div><div class="rank-info" style="flex:1; margin-left:12px; font-weight:600;">${item.emoji} ${item.nick}</div><div class="rank-score">${item.val}${unit}</div></div>`).join('');
    }

    // ê³µì§€ì‚¬í•­ ë¡œì§
    function pushNotice() {
        const title = document.getElementById('noticeTitleInput').value.trim();
        const body = document.getElementById('noticeBodyInput').value.trim();
        if(!title || !body) return alert("ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”!");
        db.ref('notices').push({ title, body, date: new Date().toLocaleString(), timestamp: Date.now() });
        document.getElementById('noticeTitleInput').value = ''; document.getElementById('noticeBodyInput').value = '';
    }
    function loadNotices() {
        db.ref('notices').orderByChild('timestamp').on('value', snap => {
            const list = document.getElementById('noticeList'); list.innerHTML = '';
            snap.forEach(child => {
                const d = child.val();
                list.innerHTML = `<div style="background:white; border:1px solid #eee; padding:15px; border-radius:15px; margin-bottom:10px;"><div style="font-size:11px; color:#999;">${d.date}</div><div style="font-weight:bold;">${d.title}</div><div style="font-size:13px; color:#666; margin-top:5px;">${d.body}</div></div>` + list.innerHTML;
            });
        });
    }
    function loadLatestNotice() { db.ref('notices').orderByChild('timestamp').limitToLast(1).on('value', snap => { snap.forEach(child => document.getElementById('latestNoticeText').innerText = child.val().title); }); }

    // UI & ê¸°íƒ€
    function switchView(viewName) {
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
        document.getElementById(viewName + 'View').classList.add('active');
        document.getElementById('sideMenu').style.display = 'none';
        if(viewName === 'todo') { renderCalendar(); loadTrainings(); }
        if(viewName === 'feed') loadGlobalFeed();
        if(viewName === 'rank') calculateRanks();
        if(viewName === 'notice') loadNotices();
        if(viewName === 'home') updateUI();
    }
    function toggleMenu() { const menu = document.getElementById('sideMenu'); menu.style.display = (menu.style.display === 'flex' ? 'none' : 'flex'); }
    function renderCalendar() {
        const grid = document.getElementById('calendarArea'); grid.innerHTML = '';
        const now = new Date(); const startDate = new Date(); startDate.setDate(now.getDate() - 15);
        for(let i=0; i<31; i++) {
            const d = new Date(startDate); d.setDate(startDate.getDate() + i);
            const ds = d.toISOString().split('T')[0];
            const box = document.createElement('div');
            box.className = `day-box ${ds === selectedDate ? 'active' : ''}`;
            box.id = `date-${ds}`;
            box.innerHTML = `<small style="font-size:10px;">${['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][d.getDay()]}</small><br>${d.getDate()}`;
            box.onclick = () => { selectedDate = ds; renderCalendar(); loadTrainings(); document.getElementById('dateLabel').innerText = `ğŸ“… ${ds} í›ˆë ¨ ì¼ì •`; };
            grid.appendChild(box);
        }
        setTimeout(() => { document.getElementById(`date-${selectedDate}`)?.scrollIntoView({ behavior: 'smooth', inline: 'center' }); }, 100);
    }
    async function fetchWeather() {
        try {
            const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=37.5665&lon=126.9780&appid=5403e0b2d279b271aec846d66c8b9532&units=metric&lang=kr`);
            const data = await response.json();
            document.getElementById('currentTemp').innerText = Math.round(data.main.temp) + "Â°";
            document.getElementById('weatherDesc').innerText = data.weather[0].description;
            document.getElementById('weatherIcon').innerHTML = `<img src="https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png" width="60">`;
        } catch (e) { document.getElementById('currentTemp').innerText = "??Â°"; }
    }
    function loadUpcomingTodos() {
        const container = document.getElementById('todoPreviewContainer');
        const todayStr = new Date().toISOString().split('T')[0];
        db.ref('trainings').orderByKey().startAt(todayStr).limitToFirst(5).on('value', (snap) => {
            container.innerHTML = ''; snap.forEach(dN => dN.forEach(tN => {
                const d = tN.val(); if(d.uid === user.uid) {
                    const item = document.createElement('div'); item.className = 'todo-item-card';
                    item.onclick = () => { selectedDate = dN.key; switchView('todo'); };
                    item.innerHTML = `<div><div style="font-size:11px;color:#a18cd1;font-weight:bold;">${dN.key.slice(5)} í›ˆë ¨</div><div style="font-weight:600;">${d.text}</div></div><span>â¯</span>`;
                    container.appendChild(item);
                }
            }));
        });
    }
    function loadHomeFeed() {
        const container = document.getElementById('homeFeedContainer');
        db.ref('trainings').limitToLast(10).on('value', (snap) => {
            container.innerHTML = ''; let count = 0;
            snap.forEach(dN => dN.forEach(tN => {
                const d = tN.val(); if(d.uid !== user.uid && count < 4) {
                    const item = document.createElement('div'); item.className = 'mini-feed-card';
                    item.innerHTML = `<span style="font-size:20px;">${d.emoji}</span><div><div style="font-size:10px; color:#a18cd1; font-weight:bold;">${dN.key.slice(5)}</div><div style="font-size:11px; color:#888;">${d.nick}</div><div style="font-size:13px; font-weight:600;">${d.text}</div></div>`;
                    container.prepend(item); count++;
                }
            }));
        });
    }
    function updateUI() {
        if(!user) return; document.getElementById('myNick').innerText = user.nick; document.getElementById('myEmoji').innerText = user.emoji;
        document.getElementById('todayDate').innerText = new Date().toLocaleDateString('ko-KR', {year:'numeric', month:'long', day:'numeric', weekday:'short'});
        fetchWeather(); loadUpcomingTodos(); loadHomeFeed();
    }
    function openProfileEdit() { document.getElementById('nickInput').value = user.nick; document.getElementById('profileOverlay').style.display = 'flex'; }
</script>
</body>
</html>
