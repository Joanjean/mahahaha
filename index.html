<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>â˜€ï¸ë§ˆí•œí´ ë„¤ë²„ìŠ¤íƒ‘ğŸ”¥</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <style>
        :root { 
            --aurora-bg: linear-gradient(215deg, #d4fc79 0%, #96e6a1 20%, #84fab0 40%, #8fd3f4 60%, #a18cd1 80%, #fbc2eb 100%);
            --pitch-dark: #4a148c; --white: #ffffff; --bg: #f8f9fa; --gray: #e0e0e0; --accent: #fffb00;
        }
        body { font-family: 'Pretendard', -apple-system, sans-serif; background-color: #f0f0f0; margin: 0; display: flex; justify-content: center; overflow-x: hidden; }
        .app-container { width: 100%; max-width: 480px; min-height: 100vh; background: var(--white); display: none; flex-direction: column; position: relative; padding-bottom: 80px; }
        
        /* ëœë”© & í”„ë¡œí•„ */
        #landingScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--aurora-bg); background-size: 400% 400%; animation: auroraMove 10s ease infinite; z-index: 3000; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.8s ease-out; }
        @keyframes auroraMove { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .rolling-ball { font-size: 60px; position: absolute; left: -100px; animation: rollAction 2.2s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        .landing-text { color: #fff; font-size: 22px; font-weight: 900; margin-top: 30px; opacity: 0; animation: fadeIn 1s 1.2s forwards; text-align: center; }

        #profileOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--aurora-bg); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(10px); }
        .profile-card { background: white; padding: 25px; border-radius: 24px; width: 85%; max-width: 340px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .emoji-picker { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; height: 300px; overflow-y: auto; border: 1px solid #eee; padding: 12px; border-radius: 12px; margin-bottom: 20px; }
        .emoji-item { font-size: 24px; cursor: pointer; padding: 8px 0; border-radius: 8px; }
        .emoji-item.selected { background: #e1bee7; transform: scale(1.1); }

        /* ë©”ì¸ UI */
        .home-header, .header-card { background: var(--aurora-bg); background-size: 200% 200%; padding: 40px 20px; color: white; border-radius: 0 0 30px 30px; }
        .weather-info { display: flex; align-items: center; gap: 15px; margin-top: 10px; }
        .temp { font-size: 2.5rem; font-weight: 900; }
        .section-title { font-size: 18px; font-weight: 800; margin: 25px 20px 10px; color: #333; display: flex; justify-content: space-between; align-items: center; }
        .todo-item-card { background: #fff; border: 1px solid #eee; border-radius: 15px; padding: 15px; margin: 0 20px 10px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .mini-feed-card { background: #fafafa; border-radius: 12px; padding: 12px; margin: 0 20px 8px; display: flex; align-items: center; gap: 10px; border-left: 4px solid #a18cd1; }
        
        /* ë­í‚¹ & ë©”ë‰´ */
        .rank-card { background: #fff; border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .rank-title { font-size: 16px; font-weight: 800; color: #4a148c; margin-bottom: 15px; }
        .rank-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f9f9f9; }
        .rank-badge { width: 24px; height: 24px; border-radius: 50%; background: var(--gray); color: white; font-size: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .rank-item:nth-child(1) .rank-badge { background: #FFD700; }
        .rank-score { font-size: 13px; color: #7b1fa2; font-weight: bold; }
        #sideMenu { position: absolute; top: 70px; left: 15px; width: 200px; background: white; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: none; flex-direction: column; z-index: 100; overflow: hidden; }
        .menu-item { padding: 15px; border-bottom: 1px solid #f0f0f0; font-size: 14px; color: #333; cursor: pointer; }

        /* í›ˆë ¨ ì¹´ë“œ & ì´ë¯¸ì§€ */
        .train-card { background: #fff; border: 1px solid #f0f0f0; border-radius: 20px; padding: 18px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.04); overflow: hidden; }
        .train-img { width: calc(100% + 36px); margin: -18px -18px 15px -18px; height: 220px; object-fit: cover; display: block; background: #eee; }
        .dot-container { display: flex; gap: 6px; margin: 12px 0; }
        .dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid var(--gray); cursor: pointer; }
        .dot.active { background: #8fd3f4; border-color: #8fd3f4; }
        .comment-section { border-top: 1px solid #f5f5f5; padding-top: 12px; margin-top: 10px; }
        .comment-item { font-size: 0.85rem; margin-bottom: 8px; display: flex; justify-content: space-between; }

        /* ê³µì§€ì‚¬í•­ */
        .notice-bar { position: fixed; bottom: 0; left: 0; width: 100%; max-width: 480px; background: #4a148c; color: white; padding: 12px 20px; display: flex; align-items: center; gap: 10px; cursor: pointer; box-sizing: border-box; z-index: 1000; font-size: 13px; }
        .notice-badge { background: var(--accent); color: #000; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 10px; }
        .notice-content { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }

        /* ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜ì—­ */
        #imgPreview { width: 45px; height: 45px; border-radius: 10px; object-fit: cover; display: none; border: 2px solid #a18cd1; }
        .upload-label { cursor: pointer; background: #f0f0f0; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 10px; font-size: 22px; }

        @keyframes rollAction { 0% { left: -100px; transform: rotate(0deg); } 100% { left: calc(50% - 30px); transform: rotate(720deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s ease; }
    </style>
</head>
<body>

<div id="landingScreen">
    <div class="ball-container"><div class="rolling-ball">âš½ï¸</div></div>
    <div class="landing-text">JUST DO IT.<br>MAPO LOAFERS</div>
</div>

<div id="profileOverlay">
    <div class="profile-card">
        <h3 id="modalTitle">ğŸƒâ€â™€ï¸ í”„ë¡œí•„ ì„¤ì •</h3>
        <input type="text" id="nickInput" onkeypress="if(event.keyCode==13) saveProfile()" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" maxlength="6" style="width:90%; padding:12px; margin-bottom:15px; border-radius:10px; border:1px solid #ddd; text-align:center;">
        <div id="emojiPicker" class="emoji-picker"></div>
        <button onclick="saveProfile()" style="width:100%; height:55px; background:linear-gradient(to right, #a18cd1, #fbc2eb); color:white; border:none; border-radius:12px; font-weight:bold;">ì €ì¥í•˜ê³  ì‹œì‘í•˜ê¸°</button>
    </div>
</div>

<div class="app-container" id="mainApp">
    <div class="notice-bar" onclick="switchView('notice')">
        <span class="notice-badge">NOTICE</span>
        <div class="notice-content" id="latestNoticeText">ê³µì§€ì‚¬í•­ ë¡œë”© ì¤‘...</div>
        <span>â¯</span>
    </div>

    <main id="homeView" class="view-section active">
        <div class="home-header">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div id="todayDate" style="font-size: 1rem; font-weight: bold;">--ë…„ --ì›” --ì¼</div>
                <div onclick="toggleMenu()" style="cursor:pointer; background:rgba(255,255,255,0.3); padding:6px 14px; border-radius:20px; font-size:13px; font-weight:bold;">ë©”ë‰´</div>
            </div>
            <div class="weather-info">
                <div id="weatherIcon" style="font-size: 3rem;">â˜€ï¸</div>
                <div><div class="temp" id="currentTemp">--Â°</div><div id="weatherDesc" style="font-weight: 600;">ë‚ ì”¨ ë¡œë”© ì¤‘...</div></div>
            </div>
        </div>
        <div class="section-title"><span>ğŸ“… ë‚˜ì˜ í›ˆë ¨ ì¼ì •</span><button onclick="switchView('todo')" style="background:none; border:none; color:#7b1fa2; font-weight:bold; font-size:12px;">ì „ì²´ë³´ê¸°</button></div>
        <div id="todoPreviewContainer"></div>
        <div class="section-title" style="margin-top:10px;"><span>ğŸ”¥ ì¹œêµ¬ë“¤ì˜ í›ˆë ¨</span><button onclick="switchView('feed')" style="background:none; border:none; color:#7b1fa2; font-weight:bold; font-size:12px;">ë”ë³´ê¸°</button></div>
        <div id="homeFeedContainer"></div>
    </main>

    <main id="todoView" class="view-section">
        <header class="header-card">
            <div class="user-bar">
                <div class="profile-trigger" onclick="toggleMenu()"><span id="myEmoji">âš½ï¸</span> <span id="myNick">ë‹‰ë„¤ì„</span></div>
                <div onclick="switchView('home')" style="cursor:pointer; font-weight:bold; background:rgba(255,255,255,0.3); padding:6px 14px; border-radius:20px; font-size:13px;">ğŸ  HOME</div>
            </div>
            <div id="calendarArea" class="week-grid"></div>
        </header>
        <div class="content-padding">
            <h4 id="dateLabel" style="color:#4a148c; margin-top:0;">ğŸ“… ë‚˜ì˜ í›ˆë ¨ ì¼ì •</h4>
            <div style="display:flex; gap:10px; margin-bottom:15px; align-items:center;">
                <label class="upload-label">ğŸ“·<input type="file" id="imageFile" accept="image/*" style="display:none;" onchange="handleImage(this)"></label>
                <img id="imgPreview">
                <input type="text" id="trainInput" onkeypress="if(event.keyCode==13) pushTraining()" placeholder="ì˜¤ëŠ˜ì˜ í›ˆë ¨ì€?" style="flex:1; padding:12px; border:1px solid #ddd; border-radius:10px;">
                <button id="uploadBtn" onclick="pushTraining()" style="background:#a18cd1; color:white; border:none; border-radius:10px; padding:12px 15px; font-weight:bold;">ë“±ë¡</button>
            </div>
            <div id="trainingContainer"></div>
        </div>
    </main>

    <main id="feedView" class="view-section">
        <div class="header-card" style="padding: 20px;"><div style="display:flex; justify-content:space-between; align-items:center;"><span style="font-weight:bold;">ğŸ‘€ ì¹œêµ¬ë“¤ ì˜í•˜ê³  ìˆë‚˜?</span><span onclick="switchView('home')" style="cursor:pointer; background:rgba(255,255,255,0.3); padding:6px 14px; border-radius:20px; font-size:13px;">ğŸ </span></div></div>
        <div id="feedContainer" class="content-padding"></div>
    </main>

    <main id="rankView" class="view-section">
        <div class="header-card" style="padding: 20px;"><div style="display:flex; justify-content:space-between; align-items:center;"><span style="font-weight:bold;">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</span><span onclick="switchView('home')" style="cursor:pointer; background:rgba(255,255,255,0.3); padding:6px 14px; border-radius:20px; font-size:13px;">ğŸ </span></div></div>
        <div class="content-padding">
            <div class="rank-card"><div class="rank-title">ğŸ”¥ í›ˆë ¨ê³„íšì™•</div><div id="planRankList">ê³„ì‚° ì¤‘...</div></div>
            <div class="rank-card"><div class="rank-title">â­ í›ˆë ¨ë‹¬ì„±ì™•</div><div id="scoreRankList">ê³„ì‚° ì¤‘...</div></div>
            <div class="rank-card"><div class="rank-title">ğŸ’¬ ëŒ“ê¸€ì‘ì›ì™•</div><div id="commentRankList">ê³„ì‚° ì¤‘...</div></div>
        </div>
    </main>

    <main id="noticeView" class="view-section">
        <div class="header-card" style="padding: 20px;"><div style="display:flex; justify-content:space-between; align-items:center;"><span style="font-weight:bold;">ğŸ“¢ ê³µì§€ì‚¬í•­</span><span onclick="switchView('home')" style="cursor:pointer; background:rgba(255,255,255,0.3); padding:6px 14px; border-radius:20px; font-size:13px;">ğŸ </span></div></div>
        <div class="content-padding">
            <div style="background:#f0f0f0; padding:15px; border-radius:12px; margin-bottom:20px;">
                <input type="text" id="noticeTitleInput" placeholder="ê³µì§€ ì œëª©" style="width:100%; padding:10px; margin-bottom:8px; border:1px solid #ddd; border-radius:8px;">
                <textarea id="noticeBodyInput" placeholder="ê³µì§€ ë‚´ìš©" style="width:100%; padding:10px; height:80px; border:1px solid #ddd; border-radius:8px;"></textarea>
                <button onclick="pushNotice()" style="width:100%; padding:12px; background:#4a148c; color:white; border:none; border-radius:8px; margin-top:8px; font-weight:bold;">ê³µì§€ ë“±ë¡</button>
            </div>
            <div id="noticeList"></div>
        </div>
    </main>

    <div id="sideMenu">
        <div class="menu-item" onclick="switchView('home')">ğŸ  í™ˆìœ¼ë¡œ</div>
        <div class="menu-item" onclick="switchView('todo')">ğŸ“… ë‚˜ì˜ í›ˆë ¨</div>
        <div class="menu-item" onclick="switchView('feed')">ğŸ‘€ ì¹œêµ¬ë“¤ í›ˆë ¨</div>
        <div class="menu-item" onclick="switchView('rank')">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</div>
        <div class="menu-item" onclick="switchView('notice')">ğŸ“¢ ê³µì§€ì‚¬í•­</div>
        <div class="menu-item" onclick="openProfileEdit()">âš™ï¸ í”„ë¡œí•„ ìˆ˜ì •</div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCCUWntonGOrv9_7pMODamJEf2hFwCex5I",
        authDomain: "maha-trainee.firebaseapp.com",
        databaseURL: "https://maha-trainee-default-rtdb.firebaseio.com",
        projectId: "maha-trainee",
        storageBucket: "maha-trainee.firebasestorage.app",
        messagingSenderId: "474313055531",
        appId: "1:474313055531:web:a7779782c1d196e06bb96e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    let user = JSON.parse(localStorage.getItem('futsal_user'));
    let selectedDate = new Date().toISOString().split('T')[0];
    let chosenEmoji = "âš½ï¸";
    let compressedBlob = null; // ì••ì¶•ëœ ì´ë¯¸ì§€ íŒŒì¼ ì €ì¥

    const emojis = ["ğŸƒâ€â™€ï¸","ğŸ‹ï¸â€â™€ï¸","ğŸš´â€â™‚ï¸","ğŸšµâ€â™€ï¸","ğŸšµâ€â™‚ï¸","ğŸ¤¸â€â™€ï¸","ğŸ§˜â€â™€ï¸","ğŸŠâ€â™€ï¸","ğŸ¤½â€â™€ï¸","â›¹ï¸â€â™€ï¸","âš½ï¸","ğŸ‘Ÿ","ğŸ”¥","ğŸ†","ğŸ’ª","âœ¨","â¤ï¸","ğŸš€","ğŸŒŸ"];

    window.addEventListener('DOMContentLoaded', () => {
        initEmojiPicker();
        setTimeout(() => {
            document.getElementById('landingScreen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('landingScreen').style.display = 'none';
                checkUserStatus();
                loadLatestNotice();
            }, 800);
        }, 2500);
    });

    function checkUserStatus() {
        if(!user || !user.uid) document.getElementById('profileOverlay').style.display = 'flex';
        else { document.getElementById('mainApp').style.display = 'flex'; updateUI(); }
    }

    function saveProfile() {
        const nick = document.getElementById('nickInput').value.trim();
        if(!nick) return alert("ë‹‰ë„¤ì„!");
        user = { uid: (user?.uid || 'u_'+Date.now()), nick, emoji: chosenEmoji };
        localStorage.setItem('futsal_user', JSON.stringify(user));
        location.reload();
    }

    function initEmojiPicker() {
        const p = document.getElementById('emojiPicker'); p.innerHTML = '';
        emojis.forEach(e => {
            const s = document.createElement('div'); s.className = `emoji-item ${e===chosenEmoji?'selected':''}`;
            s.innerText = e; s.onclick = () => { document.querySelectorAll('.emoji-item').forEach(x=>x.classList.remove('selected')); s.classList.add('selected'); chosenEmoji=e; };
            p.appendChild(s);
        });
    }

    // --- ì´ë¯¸ì§€ ì••ì¶• ì²˜ë¦¬ ë¡œì§ ---
    function handleImage(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width; let height = img.height;
                const max_size = 800; // ìµœëŒ€ ê°€ë¡œì„¸ë¡œ 800pxë¡œ ì••ì¶•
                if (width > height) { if (width > max_size) { height *= max_size / width; width = max_size; } }
                else { if (height > max_size) { width *= max_size / height; height = max_size; } }
                canvas.width = width; canvas.height = height;
                canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                canvas.toBlob(blob => {
                    compressedBlob = blob;
                    const preview = document.getElementById('imgPreview');
                    preview.src = URL.createObjectURL(blob);
                    preview.style.display = 'block';
                }, 'image/jpeg', 0.7); // 70% í™”ì§ˆë¡œ ì••ì¶•
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    async function pushTraining() {
        const input = document.getElementById('trainInput');
        if(!input.value) return;
        const btn = document.getElementById('uploadBtn');
        btn.disabled = true; btn.innerText = "ì—…ë¡œë“œ...";

        let photoUrl = "";
        if(compressedBlob) {
            const ref = storage.ref().child(`images/${user.uid}_${Date.now()}.jpg`);
            await ref.put(compressedBlob);
            photoUrl = await ref.getDownloadURL();
        }

        db.ref(`trainings/${selectedDate}`).push({ 
            uid: user.uid, nick: user.nick, emoji: user.emoji, 
            text: input.value, score: 0, photo: photoUrl, timestamp: Date.now() 
        });

        input.value = ''; compressedBlob = null;
        document.getElementById('imgPreview').style.display = 'none';
        btn.disabled = false; btn.innerText = "ë“±ë¡";
    }

    function renderCard(container, data, key, isMine, dateKey) {
        const card = document.createElement('div'); card.className = 'train-card';
        const displayDate = dateKey.split('-').slice(1).join('/');
        let imgTag = data.photo ? `<img src="${data.photo}" class="train-img">` : '';
        
        card.innerHTML = `
            ${imgTag}
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <div>
                    <span style="font-size:0.75rem; color:#a18cd1; font-weight:bold;">${displayDate}</span><br>
                    <span style="font-size:0.8rem; color:#888;">${data.nick} ${data.emoji}</span><br>
                    <strong>${data.text}</strong>
                </div>
                ${isMine ? `<div style="display:flex; gap:10px;"><button onclick="editPost('${dateKey}','${key}','${data.text}')" style="border:none;background:none;color:#a18cd1;font-size:12px;font-weight:bold;">ìˆ˜ì •</button><button onclick="deletePost('${dateKey}','${key}')" style="border:none;background:none;color:red;font-size:12px;font-weight:bold;">ì‚­ì œ</button></div>` : ''}
            </div>
            <div class="dot-container">${[1,2,3,4,5].map(i => `<div class="dot ${data.score >= i ? 'active' : ''}" onclick="${isMine ? `updateScore('${dateKey}','${key}',${i})` : ''}"></div>`).join('')}</div>
            <div class="comment-section">
                <div id="comments-${key}"></div>
                <div style="display:flex; gap:5px; margin-top:10px;">
                    <input type="text" id="c-input-${key}" onkeypress="if(event.keyCode==13) addComment('${key}')" placeholder="ì‘ì›..." style="flex:1; padding:8px; border:1px solid #eee; border-radius:8px;">
                    <button onclick="addComment('${key}')" style="background:#a18cd1; color:white; border:none; border-radius:8px;">ğŸ’¬</button>
                </div>
            </div>`;
        container.prepend(card);
        loadComments(key);
    }

    // --- ê¸°ì¡´ ëª¨ë“  ê¸°ëŠ¥ ìœ ì§€ ---
    function loadTrainings() {
        db.ref(`trainings/${selectedDate}`).on('value', snap => {
            const c = document.getElementById('trainingContainer'); c.innerHTML = '';
            snap.forEach(child => { if(child.val().uid === user.uid) renderCard(c, child.val(), child.key, true, selectedDate); });
        });
    }
    function loadGlobalFeed() {
        db.ref('trainings').on('value', snap => {
            const c = document.getElementById('feedContainer'); c.innerHTML = '';
            snap.forEach(dateNode => dateNode.forEach(t => { if(t.val().uid !== user.uid) renderCard(c, t.val(), t.key, false, dateNode.key); }));
        });
    }
    async function calculateRanks() {
        const curM = new Date().toISOString().slice(0, 7);
        let plans = {}, scores = {}, comms = {}, emap = {};
        const tSnap = await db.ref('trainings').once('value');
        tSnap.forEach(dN => dN.forEach(t => { const d = t.val(); emap[d.nick] = d.emoji; if(dN.key.startsWith(curM)) { plans[d.nick]=(plans[d.nick]||0)+1; scores[d.nick]=(scores[d.nick]||0)+(d.score||0); } }));
        const cSnap = await db.ref('comments').once('value');
        cSnap.forEach(pN => pN.forEach(cN => { comms[cN.val().nick] = (comms[cN.val().nick]||0)+1; }));
        renderRankList('planRankList', plans, 'íšŒ', emap); renderRankList('scoreRankList', scores, 'ì ', emap); renderRankList('commentRankList', comms, 'ê°œ', emap);
    }
    function renderRankList(id, data, unit, emap) {
        const c = document.getElementById(id); const s = Object.entries(data).map(([nick, val])=>({nick, val, emoji:emap[nick]||'ğŸ‘¤'})).sort((a,b)=>b.val-a.val).slice(0, 3);
        if(!s.length) { c.innerHTML = '<div style="color:#aaa;text-align:center;">ì—†ìŒ</div>'; return; }
        c.innerHTML = s.map((item, i)=>`<div class="rank-item"><div class="rank-badge">${i+1}</div><div class="rank-info">${item.emoji} ${item.nick}</div><div class="rank-score">${item.val}${unit}</div></div>`).join('');
    }
    function addComment(tK) { const i = document.getElementById(`c-input-${tK}`); if(!i.value) return; db.ref(`comments/${tK}`).push({ nick: user.nick, text: i.value }); i.value = ''; }
    function loadComments(tK) {
        db.ref(`comments/${tK}`).on('value', snap => {
            const b = document.getElementById(`comments-${tK}`); if(!b) return; b.innerHTML = '';
            snap.forEach(c => { const d=c.val(); b.innerHTML += `<div class="comment-item"><span><b>${d.nick}</b> ${d.text}</span>${d.nick===user.nick?`<span onclick="deleteComment('${tK}','${c.key}')" style="color:red;font-size:10px;">ì‚­ì œ</span>`:''}</div>`; });
        });
    }
    function deleteComment(tK, cK) { if(confirm("ì‚­ì œ?")) db.ref(`comments/${tK}/${cK}`).remove(); }
    function deletePost(dK, tK) { if(confirm("ì‚­ì œ?")) db.ref(`trainings/${dK}/${tK}`).remove(); }
    function updateScore(dK, tK, s) { db.ref(`trainings/${dK}/${tK}`).update({ score: s }); }
    function editPost(dK, tK, old) { const n = prompt("ìˆ˜ì •:", old); if(n) db.ref(`trainings/${dK}/${tK}`).update({ text: n }); }
    function pushNotice() {
        const t = document.getElementById('noticeTitleInput').value; const b = document.getElementById('noticeBodyInput').value;
        if(t && b) { db.ref('notices').push({ title:t, body:b, date:new Date().toLocaleString(), timestamp:Date.now() }); alert("ê³µì§€ ë“±ë¡ë¨"); }
    }
    function loadNotices() {
        db.ref('notices').orderByChild('timestamp').on('value', snap => {
            const l = document.getElementById('noticeList'); l.innerHTML = '';
            snap.forEach(c => { const d=c.val(); l.innerHTML = `<div class="notice-item-card"><small>${d.date}</small><div><b>${d.title}</b></div><p style="font-size:13px;">${d.body}</p></div>` + l.innerHTML; });
        });
    }
    function loadLatestNotice() { db.ref('notices').orderByChild('timestamp').limitToLast(1).on('value', snap => { snap.forEach(c => document.getElementById('latestNoticeText').innerText = c.val().title); }); }
    function renderCalendar() {
        const g = document.getElementById('calendarArea'); g.innerHTML = ''; const s = new Date(); s.setDate(s.getDate()-15);
        for(let i=0; i<31; i++) {
            const d = new Date(s); d.setDate(s.getDate()+i); const ds = d.toISOString().split('T')[0];
            const b = document.createElement('div'); b.className = `day-box ${ds===selectedDate?'active':''}`; b.id = `date-${ds}`;
            b.innerHTML = `<small>${['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][d.getDay()]}</small><br>${d.getDate()}`;
            b.onclick = () => { selectedDate=ds; renderCalendar(); loadTrainings(); document.getElementById('dateLabel').innerText=`ğŸ“… ${ds} í›ˆë ¨ ì¼ì •`; };
            g.appendChild(b);
        }
        setTimeout(()=>document.getElementById(`date-${selectedDate}`)?.scrollIntoView({behavior:'smooth',inline:'center'}), 100);
    }
    async function fetchWeather() {
        try {
            const r = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=37.5665&lon=126.9780&appid=5403e0b2d279b271aec846d66c8b9532&units=metric&lang=kr`);
            const d = await r.json();
            document.getElementById('currentTemp').innerText = Math.round(d.main.temp)+"Â°";
            document.getElementById('weatherDesc').innerText = d.weather[0].description;
            document.getElementById('weatherIcon').innerHTML = `<img src="https://openweathermap.org/img/wn/${d.weather[0].icon}@2x.png" width="50">`;
        } catch(e){}
    }
    function loadUpcomingTodos() {
        const c = document.getElementById('todoPreviewContainer');
        db.ref('trainings').orderByKey().startAt(new Date().toISOString().split('T')[0]).limitToFirst(5).on('value', snap => {
            c.innerHTML = ''; snap.forEach(dN => dN.forEach(t => { if(t.val().uid===user.uid) {
                const i = document.createElement('div'); i.className='todo-item-card'; i.onclick=()=>{selectedDate=dN.key; switchView('todo');};
                i.innerHTML = `<div><small style="color:#a18cd1">${dN.key.slice(5)}</small><br><b>${t.val().text}</b></div><span>â¯</span>`;
                c.appendChild(i);
            }}));
        });
    }
    function loadHomeFeed() {
        const c = document.getElementById('homeFeedContainer');
        db.ref('trainings').limitToLast(10).on('value', snap => {
            c.innerHTML = ''; let count = 0;
            snap.forEach(dN => dN.forEach(t => { if(t.val().uid!==user.uid && count < 3) {
                const i = document.createElement('div'); i.className='mini-feed-card';
                i.innerHTML = `<span>${t.val().emoji}</span><div><small>${dN.key.slice(5)}</small><br><b>${t.val().text}</b></div>`;
                c.prepend(i); count++;
            }}));
        });
    }
    function switchView(v) { document.querySelectorAll('.view-section').forEach(x => x.classList.remove('active')); document.getElementById(v + 'View').classList.add('active'); document.getElementById('sideMenu').style.display = 'none'; if(v==='todo'){renderCalendar();loadTrainings();} if(v==='feed')loadGlobalFeed(); if(v==='rank')calculateRanks(); if(v==='notice')loadNotices(); if(v==='home')updateUI(); }
    function toggleMenu() { const m = document.getElementById('sideMenu'); m.style.display = (m.style.display==='flex'?'none':'flex'); }
    function updateUI() { if(!user)return; document.getElementById('myNick').innerText=user.nick; document.getElementById('myEmoji').innerText=user.emoji; document.getElementById('todayDate').innerText=new Date().toLocaleDateString('ko-KR',{year:'numeric',month:'long',day:'numeric',weekday:'short'}); fetchWeather(); loadUpcomingTodos(); loadHomeFeed(); }
    function openProfileEdit() { document.getElementById('nickInput').value=user.nick; document.getElementById('profileOverlay').style.display='flex'; }
</script>
</body>
</html>
